//--menu unit
let listUrlYt = [
    "",    
    "https://youtu.be/Xj8Amv0Z52w?si=N7RCH2QWFryI2os8",
    "https://youtu.be/lfEy2xMmv0Y?si=XbVE7st0EsCahPaM",
    "https://youtu.be/ltKWFehkvVU?si=89YOlYywQw9GyVQR",
    "https://youtu.be/Zb6isCtPnEI?si=W0m_A7Sa0VAuSucR",
    "https://youtu.be/dDCfehYsrgk?si=O5SJta58aaOnuDAd",
    "https://youtu.be/vr9iQtbb6I8?si=p-fNncDUKp14lPks",
    "https://youtu.be/TLDAAk_lpyY?si=krQJdz1dXYS_9N4e",
    "https://youtu.be/C2amKJcCSFU?si=b8B0EWEdQradSZol",
    "https://youtu.be/qO8aWZ-sfTI?si=iBV4_3PcBGGovCaw",
    "https://youtu.be/K2O-8dSTmGM?si=DSEkSzg8Vio_t_Zn",
    "https://youtu.be/GOa65ir00m8?si=ah7EGu_S8p087sqR",
    
    "https://youtu.be/rvavpRuzHfY?si=VohF584qqKUy_ne1",
    "https://youtu.be/BlM-Syj6bP0?si=UhE7LKIaHNc-40TW",
    "https://youtu.be/Bjc6UI5YgDQ?si=6KhZraOa93lWanfm",
    "https://youtu.be/G1pQ1E7pYHw?si=b-zpv5KozlH5aGTy",
    "https://youtu.be/hA8HdVq3fNc?si=98-EBJpRaBXn8-TR",
    "https://youtu.be/djNclWnIvHw?si=08hIcMU1BZsrdttO",
    "https://youtu.be/vXrLxdliCiw?si=lPEqPhCWWwI5YVJ6",
    "https://youtu.be/pxLEhCufVPc?si=Ori4PlnwWzs9tkr8",
    "https://youtu.be/VMhPHWI7yvQ?si=D3QWpX99GXjAjP57",
    "https://youtu.be/hUJDSGI64pQ?si=mzckx8TcJGojLc9z",
    "https://youtu.be/iPKQCpZJTvw?si=Mk8CK9HxMjzwDtFj",
    "https://youtu.be/58geqDklMLU?si=wtFIcM-7tqgoR6cN",
    "https://youtu.be/XUIOdZj5Ni4?si=KD9ukiYJBvD8hXiT",
    "https://youtu.be/CXYoUA37Xas?si=KqE_YPkoDSiJJ_ir",
    
    "https://youtu.be/mreFzGaKLpY?si=0karBzNpkwubwRQP",
    "https://youtu.be/85GZKHYwJ1A?si=_UpY-sO_4rfupXa_",
    "https://youtu.be/M6XIzsOTdQQ?si=2kf64eY8gAdPKiC9",
    "https://youtu.be/kNZKCk6WPEo?si=XXlL5v0w5mHE-Mhd",
    "https://youtu.be/grllLeqd8pw?si=N60TGISSZdJ1c382",
    "https://youtu.be/CPGoFenijc4?si=I3vVxgdAmO4-JJwD",
    "https://youtu.be/jfztr4grDuw?si=t2jBTEEuXZUsZAwo",
    "https://youtu.be/VjnxaTriZM0?si=RMjUuAR6oFXa-T-Z",
    "https://youtu.be/6wXRxUa4wyU?si=3QcGJoxFaWIWlNUD",
    "https://youtu.be/f-Qx2UhtSEY?si=SbttDKOM9gTfZsGq",
    "https://youtu.be/DqHu21-GwBc?si=SqirGuYUBUg6wJi8",
    "https://youtu.be/YYoa2yVGymM?si=ZmIOIAhR6bafwsjm",
    "https://youtu.be/ObNoRKjfYxo?si=S9Sne-ajXasgyIMa",
    "https://youtu.be/ULo3ZCbK474?si=pWcOqBFC9Cb2Ssdp",
    "https://youtu.be/Dme7NDF-Big?si=m5cKbxaiVugUmX4C",
    "https://youtu.be/T_P6kqCQjb0?si=G1G6Obd6QorKwRL5",
    "https://youtu.be/Lpn3vGsN4bc?si=JGLLXsCdLAsPbbrn",
    "https://youtu.be/Sr9HGGU0AP4?si=wdmoj1K6Bzpc6OmD",
    "https://youtu.be/PpBNHLJ_Bdc?si=R-KD5hLNq6ALvkZc",
    "https://youtu.be/wWUTbBJnSrw?si=Q8WOHPxGwbkzsdzW",
    "https://youtu.be/6DCcF5iq9eY?si=35nznnFCrwkvOnSF",
    "https://youtu.be/MqT42QVxPV0?si=9UTJSjIzJBE4tuLP",
    "https://youtu.be/Qnj8j4Y1CIk?si=NFwDeW_nhLI9CVpG",
    "https://youtu.be/M7NHT21Udfo?si=_7eDTYcDjH9tMirK",
    
    "https://youtu.be/vG7bD1V1vYM?si=vcWo1GmILTMLhW25",
    "https://youtu.be/PBpCh6ZOOYA?si=wQEyNTFB5cxqxmO3",
    "https://youtu.be/jOHp6EqEJz0?si=Z3VZUCHMqHc59myV",
    "https://youtu.be/gXk71msBMgo?si=T2oq74NbA-AHYXjt",
    "https://youtu.be/ff3VrHmFirs?si=40PXpqNt78n3X1M_",
    "https://youtu.be/ZKb2zpoEKbg?si=T0wArJBDozwTqJDX",
    "https://youtu.be/CXWlHOjTMBM?si=GwMBw6c1rr4-yktH",
    "https://youtu.be/nz0VIbZUpPI?si=fWQDq8XH5EpaByuC",
    "https://youtu.be/2p6LN506wN0?si=foRYxUz35nc9xHsl",
    "https://youtu.be/94p8nPfEdu0?si=-1SsBYSTYU_6HkEy",
    "https://youtu.be/HPUu7Eu5bdo?si=7nLdefi_sZPFMrC_",
    "https://youtu.be/B_Fh21CwXi0?si=JNYK5_8r3HMz9_gW",
    "https://youtu.be/pjdRa8-4QCE?si=MpW76qkWuTvo2adm",
    "https://youtu.be/Mt8LcfwkfDc?si=Fxe8Hn4aS0f__HBR",
    "https://youtu.be/ZqqsH2jSxEo?si=MAOorfabrMt7JadW",
    "https://youtu.be/l92O_ie7T7o?si=3mnsM6_P7cAZ0NIx",
    "https://youtu.be/1PpuwIWJ_AU?si=Ds44pSmard2VNuAA",
    "https://youtu.be/BN1g_G_ATGc?si=0xclFCyknbaje-Bl",
    "https://youtu.be/W3vY8AB4YxQ?si=gvvU7Xk5sY_eD6Gu",
    "https://youtu.be/mkWhUuveuCo?si=B0GVbfyqlj9lPzQ-",
    "https://youtu.be/PjNfRrbSu-E?si=lniJIkM4ARXVradL",
    "https://youtu.be/toEv7eDDxPE?si=3hoJGt0Qzb_XvIzo",
    "https://youtu.be/NkJjcGoum-U?si=qlkjRDzGXgEAi41E",
    "https://youtu.be/qaFcCN23JiQ?si=VyTTQXB3NgXRC3dO",
    "https://youtu.be/sk=proj=epXwjLAeKPLBuTFMvjDmdQAhDVbhKcSZJ60xkDI4iF419uvhXC7GZ7jS7CHl8=OCemM293KtU5T3BlbkFJJ14i4QAWBYiJQbPMNBOMtspp8QL==mVbG2uig2oq44YGtjW9TFb3DdQuIrKYm7kNvvTnUqKoUA"];
    
    let list_id = ["", 
        'Xj8Amv0Z52w', 'lfEy2xMmv0Y', 'ltKWFehkvVU', 'Zb6isCtPnEI', 'dDCfehYsrgk', 'vr9iQtbb6I8', 
        'TLDAAk_lpyY', 'C2amKJcCSFU', 'qO8aWZ-sfTI', 'K2O-8dSTmGM', 'GOa65ir00m8', 'BlM-Syj6bP0',
        'Bjc6UI5YgDQ', 'G1pQ1E7pYHw', 'hA8HdVq3fNc', 'djNclWnIvHw', 'vXrLxdliCiw', 'pxLEhCufVPc', 
        'VMhPHWI7yvQ', 'hUJDSGI64pQ', 'iPKQCpZJTvw', '58geqDklMLU', 'XUIOdZj5Ni4', 'CXYoUA37Xas', 
        'mreFzGaKLpY', '85GZKHYwJ1A', 'M6XIzsOTdQQ', 'kNZKCk6WPEo', 'grllLeqd8pw', 'CPGoFenijc4', 
        'jfztr4grDuw', 'VjnxaTriZM0', '6wXRxUa4wyU', 'f-Qx2UhtSEY', 'DqHu21-GwBc', 'YYoa2yVGymM', 
        'ObNoRKjfYxo', 'ULo3ZCbK474', 'Dme7NDF-Big', 'T_P6kqCQjb0', 'Lpn3vGsN4bc', 'Sr9HGGU0AP4', 
        'PpBNHLJ_Bdc', 'wWUTbBJnSrw', '6DCcF5iq9eY', 'MqT42QVxPV0', 'Qnj8j4Y1CIk', 'M7NHT21Udfo', 
        'vG7bD1V1vYM', 'PBpCh6ZOOYA', 'jOHp6EqEJz0', 'gXk71msBMgo', 'ff3VrHmFirs', 'ZKb2zpoEKbg', 
        'CXWlHOjTMBM', 'nz0VIbZUpPI', '2p6LN506wN0', '94p8nPfEdu0', 'HPUu7Eu5bdo', 'B_Fh21CwXi0', 
        'pjdRa8-4QCE', 'Mt8LcfwkfDc', 'ZqqsH2jSxEo', 'l92O_ie7T7o', '1PpuwIWJ_AU', 'BN1g_G_ATGc', 
        'W3vY8AB4YxQ', 'mkWhUuveuCo', 'PjNfRrbSu-E', 'toEv7eDDxPE', 'NkJjcGoum-U', 'qaFcCN23JiQ'];
    
    
    let listMenuSelect = [
        'Basic Unit 1 : Introductions and Names', 
        'Basic Unit 2 : Describing people', 
        'Basic Unit 3 : Clothes', 
        'Basic Unit 4 : Routines', 
        'Basic Unit 5 : Dates', 
        'Basic Unit 6 : Jobs', 
        'Basic Unit 7 : Favorites', 
        'Basic Unit 8 : Sports and Excercise', 
        'Basic Unit 9 : Locations', 
        'Basic Unit 10 : The family', 
        'Basic Unit 11 : Entertainment', 
        'Basic Unit 12 : Prices', 
        'Basic Unit 13 : Restaurants', 
        'Basic Unit 14 : Small Talk', 
        'Basic Unit 15 : Vacations', 
        'Basic Unit 16 : Apartment Living', 
        'Basic Unit 17 : Hopes and Plans', 
        'Basic Unit 18 : The Weather', 
        'Basic Unit 19 : Shopping', 
        'Basic Unit 20 : Describing Things', 
        'Basic Unit 21 : Direction', 
        'Basic Unit 22 : People We Know', 
        'Basic Unit 23 : Places', 
        'Basic Unit 24 : Health', 
        'Developing Unit 1 : The Weekend', 
        'Developing Unit 2 : City Transportation', 
        'Developing Unit 3 : Neighbors', 
        'Developing Unit 4 : Celebrations', 
        'Developing Unit 5 : Restaurants', 
        'Developing Unit 6 : Gifts', 
        'Developing Unit 7 : Air Travel', 
        'Developing Unit 8 : Mishaps', 
        'Developing Unit 9 : Jobs', 
        'Developing Unit 10 : Keeping Fit', 
        'Developing Unit 11 : Invitations', 
        'Developing Unit 12 : Campus Life', 
        'Developing Unit 13 : Hobbies & Pastimes', 
        'Developing Unit 14 : Shopping Problems', 
        'Developing Unit 15 : Hotel Services', 
        'Developing Unit 16 : Movies', 
        'Developing Unit 17 : Fears', 
        'Developing Unit 18 : Phone Messages', 
        'Developing Unit 19 : Touring a City', 
        'Developing Unit 20 : Airports', 
        'Developing Unit 21 : Hotels', 
        'Developing Unit 22 : Traffic', 
        'Developing Unit 23 : Roommates', 
        'Developing Unit 24 : Travel', 
        'Expanding Unit 1 : Small Talk', 
        'Expanding Unit 2 : Plans', 
        'Expanding Unit 3 : Successful Businesses', 
        'Expanding Unit 4 : Apologies and Excuses', 
        'Expanding Unit 5 : Character Traits', 
        'Expanding Unit 6 : Travel', 
        'Expanding Unit 7 : Housing', 
        'Expanding Unit 8 : Can you believe it', 
        'Expanding Unit 9 : Friendship', 
        'Expanding Unit 10 : Television', 
        'Expanding Unit 11 : Cities', 
        'Expanding Unit 12 : Urban Life', 
        'Expanding Unit 13 : Special Days', 
        'Expanding Unit 14 : Fashion', 
        'Expanding Unit 15 : Favorites', 
        'Expanding Unit 16 : Phone Message', 
        'Expanding Unit 17 : Past Events', 
        'Expanding Unit 18 : Vacations', 
        'Expanding Unit 19 : The News', 
        'Expanding Unit 20 : Opinions', 
        'Expanding Unit 21 : Famous People', 
        'Expanding Unit 22 : Food and Nutrition', 
        'Expanding Unit 23 : Predicaments', 
        'Expanding Unit 24 : Global Issues'];
    
    let elmts = ['Basic Unit 1 : Introductions and Names', 
    'Basic Unit 2 : Describing people', 
    'Basic Unit 3 : Clothes', 
    'Basic Unit 4 : Routines', 
    'Basic Unit 5 : Dates', 
    'Basic Unit 6 : Jobs', 
    'Basic Unit 7 : Favorites', 
    'Basic Unit 8 : Sports and Excercise', 
    'Basic Unit 9 : Locations', 
    'Basic Unit 10 : The family', 
    'Basic Unit 11 : Entertainment', 
    'Basic Unit 12 : Prices', 
    'Basic Unit 13 : Restaurants', 
    'Basic Unit 14 : Small Talk', 
    'Basic Unit 15 : Vacations', 
    'Basic Unit 16 : Apartment Living', 
    'Basic Unit 17 : Hopes and Plans', 
    'Basic Unit 18 : The Weather', 
    'Basic Unit 19 : Shopping', 
    'Basic Unit 20 : Describing Things', 
    'Basic Unit 21 : Direction', 
    'Basic Unit 22 : People We Know', 
    'Basic Unit 23 : Places', 
    'Basic Unit 24 : Health', 
    'Developing Unit 1 : The Weekend', 
    'Developing Unit 2 : City Transportation', 
    'Developing Unit 3 : Neighbors', 
    'Developing Unit 4 : Celebrations', 
    'Developing Unit 5 : Restaurants', 
    'Developing Unit 6 : Gifts', 
    'Developing Unit 7 : Air Travel', 
    'Developing Unit 8 : Mishaps', 
    'Developing Unit 9 : Jobs', 
    'Developing Unit 10 : Keeping Fit', 
    'Developing Unit 11 : Invitations', 
    'Developing Unit 12 : Campus Life', 
    'Developing Unit 13 : Hobbies & Pastimes', 
    'Developing Unit 14 : Shopping Problems', 
    'Developing Unit 15 : Hotel Services', 
    'Developing Unit 16 : Movies', 
    'Developing Unit 17 : Fears', 
    'Developing Unit 18 : Phone Messages', 
    'Developing Unit 19 : Touring a City', 
    'Developing Unit 20 : Airports', 
    'Developing Unit 21 : Hotels', 
    'Developing Unit 22 : Traffic', 
    'Developing Unit 23 : Roommates', 
    'Developing Unit 24 : Travel', 
    'Expanding Unit 1 : Small Talk', 
    'Expanding Unit 2 : Plans', 
    'Expanding Unit 3 : Successful Businesses', 
    'Expanding Unit 4 : Apologies and Excuses', 
    'Expanding Unit 5 : Character Traits', 
    'Expanding Unit 6 : Travel', 
    'Expanding Unit 7 : Housing', 
    'Expanding Unit 8 : Can you believe it', 
    'Expanding Unit 9 : Friendship', 
    'Expanding Unit 10 : Television', 
    'Expanding Unit 11 : Cities', 
    'Expanding Unit 12 : Urban Life', 
    'Expanding Unit 13 : Special Days', 
    'Expanding Unit 14 : Fashion', 
    'Expanding Unit 15 : Favorites', 
    'Expanding Unit 16 : Phone Message', 
    'Expanding Unit 17 : Past Events', 
    'Expanding Unit 18 : Vacations', 
    'Expanding Unit 19 : The News', 
    'Expanding Unit 20 : Opinions', 
    'Expanding Unit 21 : Famous People', 
    'Expanding Unit 22 : Food and Nutrition', 
    'Expanding Unit 23 : Predicaments', 
    'Expanding Unit 24 : Global Issues'];
    
    // Main function
    function GFG_Fun() {
        for (let i = 0; i < elmts.length; i++) {
            let optn = elmts[i];
            let el = document.createElement("option");
            el.textContent = optn;
            el.value = optn;
            selectb.appendChild(el);
        }
    }
    GFG_Fun();
    function maHoaLaiAK(){
      let ch = listUrlYt[listUrlYt.length - 1].split("be/")[1].replaceAll("=","-");
      //console.log(ch);
      return ch;
    }
    //maHoaLaiAK();
//-apiKey--chat--------------------------------------------    

const resultsEl = document.getElementById('results');
const resultsdichEl = document.getElementById('resultsdich');
const voiceInEl = document.getElementById('voice');
const pitchInEl = document.getElementById('pitch');
const rateInEl = document.getElementById('rate');
const pitchOutEl = document.querySelector('output[for="pitch"]');
const rateOutEl = document.querySelector('output[for="rate"]');
const speakEl = document.getElementById('listen_button');
const start_imgEl = document.getElementById("start_img");
const listen_imgEl = document.getElementById("listen_img");
const resultsdichViqEl = document.getElementById("resultsdichViQ");
const resultsdichViaEl = document.getElementById("resultsdichViA");
const langtalkEl = document.getElementById("langtalk");

const final_spanEl = document.getElementById("final_span");
const interim_spanEl = document.getElementById("interim_span");
const chattextEl = document.getElementById("chattext");
const chatlangEl = document.getElementById("chatlang");
const lbbimatEl = document.getElementById("lbbimat");


var apiKey=maHoaLaiAK();
var demClickGPT=0;
var text='';
var langNoi='en-US';
//const results = document.getElementById("results");
//const resultsdich = document.getElementById("resultsdich");
resultsEl.style.display = "none";
resultsdichEl.style.display = "none";


//document.addEventListener("DOMContentLoaded", async () => {
//    try {
//        const response = await fetch("/api/env");
//        const data = await response.json();
//        //document.getElementById("env-value").textContent = data.envValue;
//        apiKey =  data.envValue;
//    } catch (error) {
//        console.error("Lỗi khi tải biến môi trường:", error);
        //document.getElementById("env-value").textContent = "Lỗi khi tải dữ liệu.";
//    }
//});

//--chatgpt-----------------------------
async function sendMessage(transcript) {
    let userInput = transcript;
    //alert(userInput);
    if (!userInput) return;
    //let chatbox = document.getElementById("chatbox");
    //chatbox.innerHTML += `<p><strong>Bạn:</strong> ${userInput}</p>`;
  
    // Gửi tin nhắn đến OpenAI API
    let response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [{ role: "user", content: userInput }]
      })
    });
  
    let data = await response.json();
    //console.log(data);
    let reply = data.choices[0].message.content;
    if (transcript.search("giải thích từ ngữ tiếng Anh sau đây và định dạng kết quả bằng Markdown")>0){
      //console.log(reply);
      HienThiTrongSwal(reply);
    }else{
      resultsdichEl.innerText = reply;

      let textCanDich = resultsdichEl.innerText.trim() ;
      let ptchua = resultsdichViaEl;
      if (langNoi==='en-US'){
        dichRaVi(textCanDich,ptchua);
      }else{
        dichRaEn(textCanDich,ptchua);

      }  
    
    function speakText(text) {
      // stop any speaking in progress
      window.speechSynthesis.cancel();
    
      // create new utterance with all the properties
      //const text = textEl.value;
      utterance = new SpeechSynthesisUtterance(text);
      //utterance.voice = window.speechSynthesis.getVoices().find(voice => voice.voiceURI === voiceInEl.value);
      utterance.lang = langNoi;
      utterance.pitch = pitchInEl.value;
      utterance.rate = rateInEl.value;
      //utterance.volume = volumeInEl.value;
      utterance.volume = 1;
      utterance.addEventListener('start', handleStart);
      utterance.addEventListener('end', handleEnd);

  
      // speak that utterance
      window.speechSynthesis.speak(utterance);
    }
    speakText(resultsdichEl.innerText);
  }

}

function reSpeak(){
  if (window.speechSynthesis.speaking) {window.speechSynthesis.cancel();
    listen_imgEl.src = 'icons/bot.png';
    resultsdichEl.innerHTML =   resultsdichEl.innerText;
    return;
  }

  window.speechSynthesis.cancel();
  text = resultsdichEl.innerText;
  utterance = new SpeechSynthesisUtterance(text);
  // create new utterance with all the properties
  //utterance.voice = window.speechSynthesis.getVoices().find(voice => voice.voiceURI === voiceInEl.value);
  utterance.lang = langNoi;
  utterance.pitch = pitchInEl.value;
  utterance.rate = rateInEl.value;
  //utterance.volume = volumeInEl.value;
  utterance.volume = 1;
  utterance.addEventListener('start', handleStart);
  utterance.addEventListener('end', handleEnd2);
  utterance.addEventListener('boundary', handleBoundary);
  
  // speak that utterance
  window.speechSynthesis.speak(utterance);
}


function aboutapp(){
    var dong1 = "- Bộ sách 'Tactics for lístening' của Jack C. Richards do Đại học Oxford  phát hành, được rất nhiều người dùng .\n";
    var dong2 = "- tiensg89@gmail.com tìm thấy trên mạng nên góp nhặt tải về và lập trang web này để thuận tiện sử dụng và giúp người khác trong việc tự học nghe tiếng Anh.\n";
    var dong3 = "- Nó có 3 cuốn, mỗi cuốn có 24 unit kèm theo audio để nghe. Sách có dạng 'pdf flip' rất hay.\n";
    var dong4 = "- Cách sử dụng để học là do người dùng tự khám phá và hoạch định. Bộ tài liệu nảy rất tuyệt.";
    alert(dong1+dong2+dong3+dong4);
}


//--Cac bien toan cuc--
//var text='';
var demah=0;
var messages = {//kieu dic
"start": {
  msg: 'Click on the microphone icon and begin speaking.',
  class: 'alert-success'},
"speak_now": {
  msg: 'Speak now.',
  class: 'alert-success'},
"no_speech": {
  msg: 'No speech was detected. You may need to adjust your <a href="//support.google.com/chrome/answer/2693767" target="_blank">microphone settings</a>.',
  class: 'alert-danger'},
"no_microphone": {
  msg: 'No microphone was found. Ensure that a microphone is installed and that <a href="//support.google.com/chrome/answer/2693767" target="_blank">microphone settings</a> are configured correctly.',
  class: 'alert-danger'},
"allow": {
  msg: 'Click the "Allow" button above to enable your microphone.',
  class: 'alert-warning'},
"denied": {
  msg: 'Permission to use microphone was denied.',
  class: 'alert-danger'},
"blocked": {
  msg: 'Permission to use microphone is blocked. To change, go to chrome://settings/content/microphone',
  class: 'alert-danger'},
"upgrade": {
  msg: 'Web Speech API is not supported by this browser. It is only supported by <a href="//www.google.com/chrome">Chrome</a> version 25 or later on desktop and Android mobile.',
  class: 'alert-danger'},
"stop": {
    msg: 'Stop listening, click on the microphone icon to restart',
    class: 'alert-success'},
"copy": {
  msg: 'Content copy to clipboard successfully.',
  class: 'alert-success'},
}
var final_transcript = '';
var recognizing = false;
var ignore_onend;
var start_timestamp;
var recognition;

//cac ham ung voi cac su kien
$( document ).ready(function() {
if (!('webkitSpeechRecognition' in window)) {
  upgrade();
} else {
  showInfo('start'); 
  resultsEl.innerText='';
  resultsdichEl.textContent=''; //khi dang chuan bi thi cai nay phai empty
  start_button.style.display = 'inline-block';

  recognition = new webkitSpeechRecognition();
  if (chatlangEl.innerText ==='English'){
    langNoi='en-US';
    recognition.lang = langNoi;
  }else{
    langNoi='vi-VN';
    recognition.lang = langNoi;

  }
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = function() {
    recognizing = true;
    showInfo('speak_now');
    //resultsEl.textContent=''; //khi dang chuan bi thi cai nay phai empty
    resultsdichEl.textContent=''; //khi dang chuan bi thi cai nay phai empty
    resultsEl.innerText='';
    start_imgEl.src = 'icons/mic-animation.gif';
  };

  recognition.onerror = function(event) {
    if (event.error == 'no-speech') {
      start_imgEl.src = 'icons/mic.gif';
      showInfo('no_speech');
      resultsEl.innerText='';
      resultsdichEl.textContent=''; 
      ignore_onend = true;
    }
    if (event.error == 'audio-capture') {
      start_imgEl.src = 'icons/mic.gif';
      showInfo('no_microphone');
      resultsEl.innerText='';
      resultsdichEl.textContent=''; 
      ignore_onend = true;
    }
    if (event.error == 'not-allowed') {
      resultsdichEl.textContent=''; 
      if (event.timeStamp - start_timestamp < 100) {
        showInfo('blocked');
      } else {
        showInfo('denied');
      }
      ignore_onend = true;
    }
  };

  recognition.onend = function() {
    recognizing = false;
    if (ignore_onend) {
      return;
    }
    start_imgEl.src = 'icons/mic.gif';
    if (!final_transcript) {
      showInfo('start'); 
      return;
    }
    showInfo('stop');
    //-------------------------------------------------------------------------
    //translate(); gui truy van chatgpt tu co nay
    //console.log(final_transcript);
    resultsEl.innerText = final_transcript;
    let textCanDich = resultsEl.innerText.trim() ;
    let ptchua = resultsdichViqEl;
    if (chatlangEl.innerText==='English'){
      dichRaVi(textCanDich,ptchua);
    }else{
      dichRaEn(textCanDich,ptchua);

    }
    sendMessage(final_transcript);
    //alert(final_transcript.length);

    //--------------------------------------------------------------------------
  };

  recognition.onresult = function(event) {
      var interim_transcript = '';
      resultsdichEl.textContent=''; //khi dang chuan bi thi cai nay phai empty
      //chu y rang van de kq trung gian va cuoi cung hien ra cho ta thay ct dang chay
      //nhung cuoi cung thi dich moi hien ra 
      for (var i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
              final_transcript += event.results[i][0].transcript;
          } else {
              interim_transcript += event.results[i][0].transcript; 
          }
      }
      final_transcript = capitalize(final_transcript);
      final_spanEl.textContent = linebreak(final_transcript);
      interim_spanEl.textContent = linebreak(interim_transcript);

      //sendMessage(final_transcript);
  
    //final_transcript la global nen no van ton tai ca cac thay doi, den khi ta click nghe thi moi dich
    //resultsdichEl.innerHTML=translate(final_transcript);     
    //translate(final_transcript);     
  };

}
});


function upgrade() {
  start_button.style.visibility = 'hidden';
  showInfo('upgrade');
}

var two_line = /\n\n/g;
var one_line = /\n/g;
function linebreak(s) {
return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
}

var first_char = /\S/;
function capitalize(s) {
return s.replace(first_char, function(m) { return m.toUpperCase(); });
}

//---Khi micro duoc click ------------
$("#start_button").click(function () {
  
    if (recognizing) { // neu recognizing === true tuc la da click 1 lan, lan click nay la lan 2
      //alert(recognizing);
      recognition.stop();
      return;
    }
    //alert(recognizing); // click lan 1 (lan le) recognizing===false
    window.speechSynthesis.cancel(); // cho stop cai dang tra loi
    handleEnd();
  
    final_transcript = '';


    recognition.start();
    if (chatlangEl.innerText ==='English'){
      langNoi='en-US';
      recognition.lang = langNoi;
    }else{
      langNoi='vi-VN';
      recognition.lang = langNoi;
  
    }
  
    //recognition.lang = langNoi;
    //console.log(recognition.lang);

    ignore_onend = false;
    final_spanEl.textContent = '';
    interim_spanEl.textContent = '';
    //start_img.src = 'icons/mic-slash.gif'; //neu co dong nay thi ben iphone hien ra bang hoi xin bat mic
    //alert(start_img.src);
    showInfo('allow');
    start_timestamp = event.timeStamp;
});


function showInfo(s) {
if (s) {
  var message = messages[s];
  $("#info").html(message.msg);
  $("#info").removeClass();
  $("#info").addClass('alert');
  $("#info").addClass(message.class);
} else {
  $("#info").removeClass();
  $("#info").addClass('d-none');
}
}

//xu li pit/rate/vol ----------------------------------------------------------------------------------
//khai bao cac bien toan cuc va gan gitri dau


function updateOutputs() {//---------
// display current values of all range inputs, phoi bay gtri hien huu
pitchOutEl.textContent = pitchInEl.value;
rateOutEl.textContent = rateInEl.value;
}

// add UI event handlers, khi pit/rate/vol thay doi thi chay ham updateOutputs() o tren de lay gt moi
//pitchInEl.addEventListener('change', updateOutputs);
//rateInEl.addEventListener('change', updateOutputs);

//--------lay cua net dan vao
// grab the UI elements to work with
//DN cac phan tu

// add UI event handlers
pitchInEl.addEventListener('change', updateOutputs);
rateInEl.addEventListener('change', updateOutputs);
speakEl.addEventListener('click', reSpeak);

// update voices immediately and whenever they are loaded
updateVoices();
window.speechSynthesis.onvoiceschanged = updateVoices;

function updateOutputs() {
  // display current values of all range inputs
  pitchOutEl.textContent = pitchInEl.value;
  rateOutEl.textContent = rateInEl.value;
}

function updateVoices() {
  // add an option for each available voice that isn't already added
  window.speechSynthesis.getVoices().forEach(voice => {
        const isAlreadyAdded = [...voiceInEl.options].some(option => option.value === voice.voiceURI);
        if (!isAlreadyAdded) {
            const option = new Option(voice.name, voice.voiceURI, voice.default, voice.default);
            //if ((option.value.search("English")>0) || (option.value.search("en-US")>0) || (option.value.search("Linh")>0) || (option.value.search("An")>0) || (option.value.search("vi-VN")>0)){
            if ( (option.value.search("English")>0) || (option.value.search("en-US")>0) || (option.value.search("An")>0) || (option.value.search("Linh")>0)  ){
                //console.log(option);
                if (option.value.search("Samantha")>=0){
                  option.selected=true;
                }
                voiceInEl.add(option);
            }
                
        }
    
  });
  
}

function anHienText_GPT(){
  demClickGPT += 1;
  if (demClickGPT%2 === 1){
    resultsEl.style.display = "block";
    resultsdichEl.style.display = "block";

  }else{
    resultsEl.style.display = "none";
    resultsdichEl.style.display = "none";

    //document.getElementById("results").style.clipPath = "inset(0%)";
    //document.getElementById("resultsdich").style.clipPath = "inset(0%)";

  } 
}
resultsdichViqEl.style.display = "none";
resultsdichViaEl.style.display = "none";

//==============
function handleStart() {
  listen_imgEl.src = 'icons/mic-animation.gif';
}


function handleEnd() {
  listen_imgEl.src = 'icons/bot.png';
}
function handleEnd2() {
  listen_imgEl.src = 'icons/bot.png';
  resultsdichEl.innerHTML = text;
}

function handleBoundary(event) {
  if (event.name === 'sentence') {
    // we only care about word boundaries
    return;
  }

  const wordStart = event.charIndex;

  let wordLength = event.charLength;
  if (wordLength === undefined) {
    // Safari doesn't provide charLength, so fall back to a regex to find the current word and its length (probably misses some edge cases, but good enough for this demo)
    const match = text.substring(wordStart).match(/^[a-z\d']*/i);
    wordLength = match[0].length;
  }
  
  // wrap word in <mark> tag
  const wordEnd = wordStart + wordLength;
  const word = text.substring(wordStart, wordEnd);
  const markedText = text.substring(0, wordStart) + '<mark>' + word + '</mark>' + text.substring(wordEnd);
  resultsdichEl.innerHTML = markedText; //phan nay co ma trong resultsdichEl nen phai innerHTML
}
//------------------------
function speakTextVi(){ //ham nay doc QA noi bi mat
  if (window.speechSynthesis.speaking) {window.speechSynthesis.cancel();
    return;
  }

    let textNoi = resultsdichViqEl.innerText.trim() + " . " + resultsdichViaEl.innerText.trim();
    if (textNoi.trim()==="."){return;}
    const speech = new SpeechSynthesisUtterance();
    if (langNoi==='en-US'){
      speech.lang = "vi-VN"; // Đọc tiếng Vi
    }else{
      speech.lang = "en-US"; // Đọc tiếng Vi

    }  
    speech.text = textNoi;
    speech.rate = 1;
    speech.pitch = 1;
    speech.volume = 2;
    speechSynthesis.speak(speech);
}
//--------------------
function stopVideo() {
  let iframe = document.getElementById("iframe_yt");
  let videoUrl = iframe.src; // Lưu lại URL video
  iframe.src = ""; // Xóa src để dừng
  setTimeout(() => iframe.src = videoUrl, 100); // Gán lại URL sau 100ms
}

//----------------
function GoOff(){
  resultsEl.innerText="";
  resultsdichEl.innerText="";
  start_imgEl.src = "icons/mic.gif";
  listen_imgEl.src = "icons/bot.png";
  resultsdichViqEl.innerText = "";
  resultsdichViaEl.innerText = "";
   
  const synth = window.speechSynthesis;
  if (synth.speaking) {synth.cancel();}

  stopVideo();  
}

//----Ham Dich ra Vi------------------
function dichRaVi(textCanDich,ptchua){
  const inputText = textCanDich;
  let sourceLanguage = 'en';
  let targetLanguage = 'vi';

  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(inputText)}`;

  const xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200){
        const responseReturned = JSON.parse(this.responseText);
        const translations = responseReturned[0].map((text) => text[0]);
        const outputText = translations.join(" ");
        //console.log(outputText);
        ptchua.innerText = ' '+outputText;
    }
  };
  xhttp.open("GET", url);
  xhttp.send();

}
//----Ham Dich ra En------------------
function dichRaEn(textCanDich,ptchua){
  const inputText = textCanDich;
  let sourceLanguage = 'vi';
  let targetLanguage = 'En';

  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(inputText)}`;

  const xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200){
        const responseReturned = JSON.parse(this.responseText);
        const translations = responseReturned[0].map((text) => text[0]);
        const outputText = translations.join(" ");
        //console.log(outputText);
        ptchua.innerText = ' '+outputText;
    }
  };
  xhttp.open("GET", url);
  xhttp.send();

}

//----------------- html de chat t Vi voi GPT -----------------------
let finalSpeechText = ""; // Biến toàn cục để lưu văn bản khi nhấn OK

function chatTiengViet() {
Swal.fire({
    title: "<span style='color:darkgreen;'>Chat bằng tiếng Việt</span>",
    html: `
  <p style="text-align: left; color:orange;">Chọn một yêu cầu để thiết lập trước cụm từ sẽ được nhập:</p>
	<div style="text-align: left;  color:green;"><input type="radio" name="pre-sentence" value="" checked>(để trống)</div>
	<div style="text-align: left; color:darkgreen;"><input type="radio" name="pre-sentence" value="Đưa ra một ví dụ về một câu tiếng Việt có chứa từ sau : ">Đưa ra một ví dụ về một câu tiếng Việt có chứa từ sau : </div>
	<div style="text-align: left;  color:green;"><input type="radio" name="pre-sentence" value="Đưa ra một ví dụ về một câu tiếng Việt có cụm từ sau : ">Đưa ra một ví dụ về một câu tiếng Việt có cụm từ sau : </div>
	<div style="text-align: left;  color:darkgreen;"><input type="radio" name="pre-sentence" value="Đưa ra một ví dụ về một câu tiếng Việt có câu trả lời có thể như sau : ">Đưa ra một ví dụ về một câu tiếng Việt có câu trả lời có thể như sau : </div>
	<div style="text-align: left;  color:green;"><input type="radio" name="pre-sentence" value="Nói một câu tiếng Việt khiến tôi phải trả lời như thế này : ">Nói một câu tiếng Việt khiến tôi phải trả lời như thế này : </div>
      <textarea id="input-text" class="swal2-input" placeholder="Nhập văn bản tiếng Việt" ></textarea>
      <textarea id="translated-text" class="swal2-textarea" placeholder="Bản dịch tiếng Anh sẽ hiển thị ở đây..."></textarea>
      <br>
      <button id="speak-button" class="swal2-confirm swal2-styled" style="display: none; margin-top: 10px;">🔊 Đọc</button>
      `,
showCancelButton: true,
confirmButtonText: "OK gửi đi",
cancelButtonText: "Hủy",
}).then((result) => {
  if (result.isConfirmed) {
    var cauhoi='';
    var ele = document.getElementsByName('pre-sentence');
    for (i = 0; i < ele.length; i++) {
			if (ele[i].checked){
        cauhoi = ele[i].value;
		  }
    }    
    finalSpeechText = cauhoi + '"' + document.getElementById("input-text").value.trim()+ '"'; // Lưu văn bản vào biến
    //console.log("Văn bản sau khi nhấn OK:", finalSpeechText); // Bạn có thể dùng biến này để xử lý tiếp

    //--text Vi vua input duoc ghi vao elem hoi----
    if (finalSpeechText.trim()!==''){
      resultsEl.innerText = finalSpeechText;
  
    //text nay can dich sang tieng Anh ghi vao noi bi mat de co the doc len sau nay
    let textCanDich = resultsEl.innerText.trim() ;
      //alert(textCanDich);
      let ptchua = resultsdichViqEl;
    dichRaEn(textCanDich,ptchua);

    sendMessage(resultsEl.innerText);
    } else {alert('Không gửi vì chưa nhập gì!')};
    /////////////////////////////
  }
});

// Chờ SweetAlert2 render xong rồi mới gán sự kiện
setTimeout(() => {
    const inputText = document.getElementById("input-text");
    const translatedText = document.getElementById("translated-text");
    const speakButton = document.getElementById("speak-button");
    // Khi nhập tay, cũng tự động dịch
    inputText.addEventListener("change", () => {
      //alert(inputText.value);
      let textCanDich = inputText.value.trim();
      if (textCanDich.length > 0) {
        translateTextRaEn(textCanDich,translatedText);
        speakButton.style.display = "inline-block";
      } else {
        translatedText.value='';
        speakButton.style.display = "none";
      }
    });
    // Khi nhấn nút đọc 🔊
    speakButton.addEventListener("click", () => {
      speakTextAPIen(translatedText.value);
    });
  }, 100);
  // 🎤 Hàm đọc văn bản bằng SpeechSynthesis API
  function speakTextAPIen(text) {
    const speech = new SpeechSynthesisUtterance();
    speech.lang = "en-US"; // Đọc tiếng Anh
    speech.text = text;
    speech.rate = 1.0;
    speech.pitch = 1.0;
    speech.volume = 1;
    speechSynthesis.speak(speech);
  }

}

//📝 Hàm dịch văn bản sử dụng API miễn phí
function translateTextRaEn(textCanDich,ptchua) {
  const inputText = textCanDich;
  let sourceLanguage = 'vi';
  let targetLanguage = 'en';

  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(inputText)}`;

  const xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200){
        const responseReturned = JSON.parse(this.responseText);
        const translations = responseReturned[0].map((text) => text[0]);
        const outputText = translations.join(" ");
        //console.log(outputText);
        ptchua.value = ' '+outputText;
        
    }
  };
  xhttp.open("GET", url);
  xhttp.send();

}
//----------------------------------
function HienThiTrongSwal(replytrave){
  Swal.fire({
    title: "ChatGPT Reply",
    html: marked.parse(replytrave), // Hiển thị Markdown dưới dạng HTML
    width: "600px",
    confirmButtonText: "OK"
  });
}
//---Tu lay khi click---
resultsdichEl.addEventListener("click", function(event) {
  let selectedText = getWordAtClick(event);
  if (selectedText) {
    //console.log("Từ được chọn:", selectedText);
    //alert(word);
    if (selectedText.length > 0) {
        let vbyeucau = "Hãy giải thích từ ngữ tiếng Anh sau đây và định dạng kết quả bằng Markdown : " + "'" + selectedText + "'";
        sendMessage(vbyeucau);
    }
  
  }
});
  
function getWordAtClick(event) {
  let range, textNode, offset;
  
  if (document.caretRangeFromPoint) { // Cho Chrome, Edge, Firefox
    range = document.caretRangeFromPoint(event.clientX, event.clientY);
  } else if (document.caretPositionFromPoint) { // Cho Safari
    let pos = document.caretPositionFromPoint(event.clientX, event.clientY);
    range = document.createRange();
    range.setStart(pos.offsetNode, pos.offset);
  }
  
  if (range) {
    textNode = range.startContainer;
    offset = range.startOffset;
  
    if (textNode.nodeType === Node.TEXT_NODE) {
      let text = textNode.nodeValue;
      let before = text.slice(0, offset).split(/\s+/).pop(); // Lấy từ trước con trỏ
      let after = text.slice(offset).split(/\s+/)[0]; // Lấy từ sau con trỏ
      return before + after; // Ghép lại thành từ đầy đủ
    }
  }
  return null;
}
//----------------------------
chattextEl.addEventListener("click", function(event) {
  if (chatlangEl.innerText==='English'){
    langNoi='en-US';
    chatTiengAnh();
  }else{
    langNoi='vi-VN';
    chatTiengViet();
  }
});
//----------------
chatlangEl.addEventListener("click", function(event) {
  if (chatlangEl.innerText==='English'){
    chatlangEl.innerText='Vietnamese';
  }else{
    chatlangEl.innerText='English';
  }
});
//--------------------------------------------------------------------
function chatTiengAnh() {
  Swal.fire({
      title: "<span style='color:darkgreen;'>Chat in English</span>",
      html: `
  <p style="text-align: left; color:orange;">Select a request to pre-set the phrase to be entered:</p>
	<div style="text-align: left;  color:green;"><input type="radio" name="pre-sentence" value="" checked>(leave blank)</div>
	<div style="text-align: left; color:darkgreen;"><input type="radio" name="pre-sentence" value="Give an example of an English sentence with the following word : ">Give an example of an English sentence with the following word : </div>
	<div style="text-align: left;  color:green;"><input type="radio" name="pre-sentence" value="Give an example of an English sentence with the following phrase : ">Give an example of an English sentence with the following phrase : </div>
	<div style="text-align: left;  color:darkgreen;"><input type="radio" name="pre-sentence" value="Give an example of an English statement whose answer could be as follows : ">Give an example of an English statement whose answer could be as follows : </div>
	<div style="text-align: left;  color:green;"><input type="radio" name="pre-sentence" value="Say an English sentence that would make me answer like this : ">Say an English sentence that would make me answer like this : </div>

  <br>

      <textarea id="input-text" class="swal2-input" placeholder="Enter English text"></textarea>
        <textarea id="translated-text" class="swal2-textarea" placeholder="Vietnamese translation will display here..."></textarea>
        <br>
        <button id="speak-button" class="swal2-confirm swal2-styled" style="display: none; margin-top: 10px;">🔊 Đọc</button>
        `,
  showCancelButton: true,
  confirmButtonText: "OK gửi đi",
  cancelButtonText: "Hủy",
  }).then((result) => {
    if (result.isConfirmed) {
      var cauhoi='';
      var ele = document.getElementsByName('pre-sentence');
      for (i = 0; i < ele.length; i++) {
        if (ele[i].checked){
          cauhoi = ele[i].value;
        }
      }    
  
      finalSpeechText = document.getElementById("input-text").value; // Lưu văn bản vào biến
      //console.log("Văn bản sau khi nhấn OK:", finalSpeechText); // Bạn có thể dùng biến này để xử lý tiếp
      //--text in put se dc dat noi cau hoi tru van
      if (finalSpeechText.trim()!==''){
      resultsEl.innerText = cauhoi + '"' + finalSpeechText + '"';
      
      //--text in put cung se dc dich ra vi dat noi bi mat de tham khao roi se send toi gpt
      let textCanDich = resultsEl.innerText.trim() ;
      //alert(textCanDich);
      let ptchua = resultsdichViqEl;
      dichRaVi(textCanDich,ptchua);
      //text input dc gui di cho gpt  
      sendMessage(resultsEl.innerText);
      } else {alert('Không gửi vì chưa nhập gì!')};
      /////////////////////////////
    }
  });
  
  // Chờ SweetAlert2 render xong rồi mới gán sự kiện
  setTimeout(() => {
      const inputText = document.getElementById("input-text");
      const translatedText = document.getElementById("translated-text");
      const speakButton = document.getElementById("speak-button");
      // Khi nhập tay, cũng tự động dịch
      inputText.addEventListener("change", () => {
        //alert(inputText.value);
        let textCanDich = inputText.value.trim();
        if (textCanDich.length > 0) {
          translateTextRaVi(textCanDich,translatedText);
          speakButton.style.display = "inline-block";
        } else {
          translatedText.value='';
          speakButton.style.display = "none";
        }
      });
      // Khi nhấn nút đọc 🔊
      speakButton.addEventListener("click", () => {
        speakTextAPIvi(translatedText.value);
      });
    }, 100);
    // 🎤 Hàm đọc văn bản bằng SpeechSynthesis API
    function speakTextAPIvi(text) {
      const speech = new SpeechSynthesisUtterance();
      speech.lang = "vi-VN"; // Đọc tiếng Anh
      speech.text = text;
      speech.rate = 1.0;
      speech.pitch = 1.0;
      speech.volume = 1;
      speechSynthesis.speak(speech);
    }
  
  }
  
  //📝 Hàm dịch văn bản sử dụng API miễn phí
  function translateTextRaVi(textCanDich,ptchua) {
    const inputText = textCanDich;
    let sourceLanguage = 'en';
    let targetLanguage = 'vi';
  
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(inputText)}`;
  
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200){
          const responseReturned = JSON.parse(this.responseText);
          const translations = responseReturned[0].map((text) => text[0]);
          const outputText = translations.join(" ");
          //console.log(outputText);
          ptchua.value = ' '+outputText;
          
      }
    };
    xhttp.open("GET", url);
    xhttp.send();
  
  }
  //------
lbbimatEl.addEventListener('click', function(event){
    
    let qq = resultsdichViqEl.innerText;
    let aa = resultsdichViaEl.innerText;
    Swal.fire({
      title: "<span style='color:darkgreen;'>Translated Text</span>",
      html: `
        <div id="hienbdQ" style="text-align: left;  color:orange;">Q: `+qq+`</div>
        <div id="hienbdA" style="text-align: left;  color:green;">A: `+aa+`</div>
	      `,
      
      confirmButtonText: "OK",
  })

});